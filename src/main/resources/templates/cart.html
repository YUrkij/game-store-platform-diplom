<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Корзина - GameStore</title>
  <style>
    /* Все стили из common.html */
    :root { /* ... */ }
    .dark-theme { /* ... */ }
    * { /* ... */ }
    body { /* ... */ }
    header { /* ... */ }
    .header-content { /* ... */ }
    .logo { /* ... */ }
    .auth-buttons { /* ... */ }
    .user-info { /* ... */ }
    .balance { /* ... */ }
    .btn { /* ... */ }
    .btn-primary { /* ... */ }
    .btn-secondary { /* ... */ }
    .btn-small { /* ... */ }
    main { /* ... */ }
    footer { /* ... */ }
    .footer-content { /* ... */ }
    .theme-switcher { /* ... */ }
    .modal { /* ... */ }
    .modal-content { /* ... */ }

    /* Дополнительные стили для cart */
    .cart-item {
        display: grid;
        grid-template-columns: 100px 1fr auto auto;
        gap: 1rem;
        align-items: center;
        background: var(--bg-card);
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        box-shadow: var(--shadow);
    }

    .cart-item-image {
        width: 100px;
        height: 60px;
        object-fit: cover;
        border-radius: 5px;
    }

    .cart-summary {
        background: var(--bg-card);
        padding: 1.5rem;
        border-radius: 10px;
        margin-top: 2rem;
        box-shadow: var(--shadow);
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .total {
        font-size: 1.2rem;
        font-weight: bold;
        border-top: 1px solid var(--border-color);
        padding-top: 1rem;
        margin-top: 1rem;
    }

    .empty-cart {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }
  </style>
</head>
<body>
<header>
  <div class="header-content">
    <div class="logo">GameStore</div>
    <div class="auth-buttons" id="authButtons"></div>
  </div>
</header>

<main>
  <h1>Корзина покупок</h1>

  <div id="cartItems">
    <!-- Товары в корзине -->
  </div>

  <div id="cartSummary" class="cart-summary" style="display: none;">
    <div class="summary-row">
      <span>Стоимость товаров:</span>
      <span id="subtotal">0 ₽</span>
    </div>
    <div class="summary-row">
      <span>Скидка:</span>
      <span id="discount">0 ₽</span>
    </div>
    <div class="summary-row total">
      <span>Итого к оплате:</span>
      <span id="total">0 ₽</span>
    </div>
    <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="processPurchase()">
      Оформить заказ
    </button>
  </div>
</main>

<!-- Модальное окно успешной покупки -->
<div id="successModal" class="modal">
  <div class="modal-content">
    <h3>Покупка успешно завершена!</h3>
    <p>Игра добавлена в вашу библиотеку.</p>
    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
      <button class="btn btn-primary" onclick="goToLibrary()">Перейти в библиотеку</button>
      <button class="btn btn-secondary" onclick="goToHome()">В магазин</button>
    </div>
  </div>
</div>

<footer>
  <div class="footer-content">
    <div>&copy; 2024 GameStore Platform. Все права защищены.</div>
    <div class="theme-switcher" onclick="toggleTheme()">
      <span id="themeText">Тёмная тема</span>
    </div>
  </div>
</footer>

<script>
  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  function loadCart() {
      if (!currentUser) {
          window.location.href = 'login.html';
          return;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const gameId = urlParams.get('gameId');

      // Если перешли с кнопки "Купить", добавляем игру в корзину
      if (gameId && !cart.find(item => item.id === parseInt(gameId))) {
          const games = [
              {
                  id: 1,
                  title: "The Witcher 3: Wild Hunt",
                  price: 1999,
                  image: "https://via.placeholder.com/300x200/6c63ff/ffffff?text=Witcher+3"
              },
              {
                  id: 2,
                  title: "Cyberpunk 2077",
                  price: 2999,
                  image: "https://via.placeholder.com/300x200/ff6b9d/ffffff?text=Cyberpunk"
              },
              {
                  id: 3,
                  title: "Half-Life 2",
                  price: 499,
                  image: "https://via.placeholder.com/300x200/8b5cf6/ffffff?text=Half-Life+2"
              }
          ];

          const game = games.find(g => g.id === parseInt(gameId));
          if (game) {
              cart.push(game);
              localStorage.setItem('cart', JSON.stringify(cart));
          }
      }

      renderCart();
  }

  function renderCart() {
      const cartContainer = document.getElementById('cartItems');
      const summaryContainer = document.getElementById('cartSummary');

      if (cart.length === 0) {
          cartContainer.innerHTML = `
              <div class="empty-cart">
                  <h3>Корзина пуста</h3>
                  <p>Добавьте игры из <a href="home.html">магазина</a></p>
              </div>
          `;
          summaryContainer.style.display = 'none';
          return;
      }

      cartContainer.innerHTML = cart.map(item => `
          <div class="cart-item">
              <img src="${item.image}" alt="${item.title}" class="cart-item-image">
              <div>
                  <h3>${item.title}</h3>
              </div>
              <div style="font-weight: bold;">${item.price} ₽</div>
              <button class="btn btn-secondary btn-small" onclick="removeFromCart(${item.id})">Удалить</button>
          </div>
      `).join('');

      updateSummary();
      summaryContainer.style.display = 'block';
  }

  function updateSummary() {
      const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
      const discount = 0; // Можно добавить систему скидок
      const total = subtotal - discount;

      document.getElementById('subtotal').textContent = `${subtotal} ₽`;
      document.getElementById('discount').textContent = `-${discount} ₽`;
      document.getElementById('total').textContent = `${total} ₽`;
  }

  function removeFromCart(gameId) {
      cart = cart.filter(item => item.id !== gameId);
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
  }

  function processPurchase() {
      const total = cart.reduce((sum, item) => sum + item.price, 0);

      if (currentUser.balance < total) {
          alert('Недостаточно средств на балансе!');
          return;
      }

      // Обновляем баланс пользователя
      const users = JSON.parse(localStorage.getItem('users'));
      const userIndex = users.findIndex(u => u.id === currentUser.id);

      if (userIndex !== -1) {
          users[userIndex].balance -= total;

          // Добавляем игры в библиотеку
          if (!users[userIndex].library) {
              users[userIndex].library = [];
          }

          cart.forEach(game => {
              users[userIndex].library.push({
                  ...game,
                  purchaseDate: new Date().toISOString(),
                  purchasePrice: game.price
              });
          });

          // Обновляем текущего пользователя
          currentUser.balance = users[userIndex].balance;
          currentUser.library = users[userIndex].library;

          localStorage.setItem('users', JSON.stringify(users));
          localStorage.setItem('currentUser', JSON.stringify(currentUser));

          // Очищаем корзину
          cart = [];
          localStorage.setItem('cart', JSON.stringify(cart));

          // Показываем успешное сообщение
          document.getElementById('successModal').style.display = 'block';
      }
  }

  function goToLibrary() {
      window.location.href = 'user.html';
  }

  function goToHome() {
      window.location.href = 'home.html';
  }

  // Инициализация
  document.addEventListener('DOMContentLoaded', function() {
      loadTheme();
      updateAuthButtons();
      loadCart();
  });

  // Функции из common.html
  function toggleTheme() { /* ... */ }
  function loadTheme() { /* ... */ }
  function updateAuthButtons() { /* ... */ }
  function logout() { /* ... */ }
</script>
</body>
</html>